<h2 mat-dialog-title>Configuración de Asignaturas de la Carrera</h2>

<mat-dialog-content class="mat-typography">
  
  <div class="selection-area">
    <mat-form-field appearance="outline" class="flex-grow">
      <mat-label>Asignatura para Agregar</mat-label>
      <mat-select [(ngModel)]="selectedSubjectToAdd">
        <!-- Muestra las asignaturas disponibles del backend que no están en la tabla -->
        <mat-option *ngFor="let subject of availableForAddition" [value]="subject.id">
          {{ subject.name }}
        </mat-option>
      </mat-select>
    </mat-form-field>
    
    <button 
      mat-flat-button 
      color="primary" 
      [disabled]="!selectedSubjectToAdd" 
      class="ml-3"
      (click)="addSubject()">
      <mat-icon>add</mat-icon> Agregar
    </button>
  </div>
  
  <div class="table-container mat-elevation-z2 mt-4">
    <table mat-table [dataSource]="dataSource" class="w-full">

      <!-- Columna de Nombre -->
      <ng-container matColumnDef="name">
        <th mat-header-cell *matHeaderCellDef> Asignatura </th>
        <td mat-cell *matCellDef="let element"> {{ element.name }} </td>
      </ng-container>

      <!-- Columna de Año -->
      <ng-container matColumnDef="year">
        <th mat-header-cell *matHeaderCellDef> Año </th>
        <td mat-cell *matCellDef="let element"> 
          <mat-form-field appearance="outline" class="w-20">
            <input matInput type="number" 
                   min="1" 
                   [(ngModel)]="element.year" 
                   required>
          </mat-form-field>
        </td>
      </ng-container>

      <!-- Columna de Correlatividad -->
      <ng-container matColumnDef="correlative">
        <th mat-header-cell *matHeaderCellDef> Correlatividad Requerida </th>
        <td mat-cell *matCellDef="let element">
          <mat-form-field appearance="outline" class="w-full">
            <mat-select 
              [(ngModel)]="element.correlativeId" 
              [compareWith]="compareSubjectIds"
              [disabled]="getCorrelativeOptions(element.subjectId).length === 0">
              
              <!-- CAMBIO CRÍTICO: Usamos una cadena única en lugar de [value]="null" -->
              <mat-option [value]="'NO_CORRELATIVE'">No se necesita correlatividad</mat-option>
              
              <!-- Muestra el resto de las materias configuradas en la tabla -->
              <mat-option *ngFor="let corr of getCorrelativeOptions(element.subjectId)" [value]="corr.subjectId">
                {{ corr.name }} (Año {{ corr.year }})
              </mat-option>
            </mat-select>
            <mat-hint *ngIf="getCorrelativeOptions(element.subjectId).length === 0 && element.year > 1">
                Añada más materias para correlativas.
            </mat-hint>
          </mat-form-field>
        </td>
      </ng-container>

      <!-- Columna de Acciones -->
      <ng-container matColumnDef="actions">
        <th mat-header-cell *matHeaderCellDef> Eliminar </th>
        <td mat-cell *matCellDef="let element">
          <button mat-icon-button color="warn" (click)="removeSubject(element.tempId)">
            <mat-icon>delete</mat-icon>
          </button>
        </td>
      </ng-container>

      <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
      <tr mat-row *matRowDef="let row; columns: displayedColumns"></tr>
      
      <!-- Fila de No Resultados -->
      <tr class="mat-row" *matNoDataRow>
        <td class="mat-cell text-center py-4 text-gray-500" [attr.colspan]="displayedColumns.length">
          Aún no ha agregado asignaturas. Use el selector superior para comenzar.
        </td>
      </tr>

    </table>
  </div>
  
</mat-dialog-content>

<mat-dialog-actions align="end">
  <button mat-button (click)="onCancelar()">Cancelar</button>
  <button mat-raised-button 
          color="primary" 
          [disabled]="dataSource.data.length === 0" 
          (click)="onGuardar()">
    Aceptar Configuración
  </button>
</mat-dialog-actions>